<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Residency Questionaire</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --accent:#007aff; --muted:#666; --line:#e9e9ee;
  }
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;margin:18px;background:var(--bg);color:#111}
  main{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
  h1{margin:15px 0 35px 0;font-size:1.50rem}
  .section{background:#fbfbfd;border:1px solid #eee;padding:14px;border-radius:10px;margin:12px 0}
  .section h2{margin:0 0 10px 0;font-size:1.05rem}
  label{display:block;margin:8px 0;font-size:0.95rem}
  input[type=text],input[type=email],input[type=number],input[type=tel],select,textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-top:6px;font-size:1rem;background:#fff
  }
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .muted{color:var(--muted);font-size:0.85rem}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.secondary{background:#999}
  button.ghost{background:transparent;border:1px solid var(--line);color:#333}
  .actions{display:flex;gap:12px;align-items:center}


  /* Nominee grid */
  .nominee-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .nominee{background:#fff;padding:12px;border-radius:10px;border:1px solid #eee;position:relative}
  .nominee h3{margin:0 0 8px 0;font-size:0.95rem;display:flex;align-items:center;justify-content:space-between}
  .nominee .remove-btn{background:transparent;border:1px solid var(--line);color:#333;border-radius:8px;padding:6px 10px;font-size:0.9rem}
  .nominee .remove-btn:hover{border-color:#d0d0d7}

    /* Next12 grid */
  .next12-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .next12{background:#fff;padding:12px;border-radius:10px;border:1px solid #eee;position:relative}
  .next12 h3{margin:0 0 8px 0;font-size:0.95rem;display:flex;align-items:center;justify-content:space-between}
  .next12 .remove-btn{background:transparent;border:1px solid var(--line);color:#333;border-radius:8px;padding:6px 10px;font-size:0.9rem}
  .next12 .remove-btn:hover{border-color:#d0d0d7}

    /* Occupation grid */
  .occupation-grid{display:grid;grid-template-columns:1fr;gap:12px}
  .occupation{background:#fff;padding:12px;border-radius:10px;border:1px solid #eee;position:relative}
  .occupation h3{margin:0 0 8px 0;font-size:0.95rem;display:flex;align-items:center;justify-content:space-between}
  .occupation .remove-btn{background:transparent;border:1px solid var(--line);color:#333;border-radius:8px;padding:6px 10px;font-size:0.9rem}
  .occupation .remove-btn:hover{border-color:#d0d0d7}
  
    /* Companyowner grid */
  .compowner-grid{display:grid;grid-template-columns:1fr;gap:12px}
  .compowner{background:#fff;padding:12px;border-radius:10px;border:1px solid #eee;position:relative}
  .compowner h3{margin:0 0 8px 0;font-size:0.95rem;display:flex;align-items:center;justify-content:space-between}
  .compowner .remove-btn{background:transparent;border:1px solid var(--line);color:#333;border-radius:8px;padding:6px 10px;font-size:0.9rem}
  .compowner .remove-btn:hover{border-color:#d0d0d7}
  
  /* Signature preview tiles */
  .sig-preview{
    width:100%; height:150px; border:1px dashed #bbb; border-radius:10px;
    display:flex; align-items:center; justify-content:center; background:#fff; cursor:pointer; position:relative;
  }
  .sig-preview img{ max-width:100%; max-height:100%; object-fit:contain; }
  .sig-preview span{ color:#999; }

  /* Signature Modal */
  .sig-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; }
  .sig-modal .box{
    width:min(560px, 92vw); background:#fff; margin:6vh auto; padding:14px; border-radius:12px;
    box-shadow:0 18px 50px rgba(0,0,0,.25)
  }
  .sig-modal h3{ margin:0 0 8px 0; }
  /* NOTE: canvas is responsive via CSS; internal pixels are set in JS for crispness */
  #sigCanvas{ width:100%; height:220px; background:#fff; border:1px solid #ddd; border-radius:10px; touch-action:none }
  .sig-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }

    /* XY% signature tuning  */
   .hidden-inputs {display: none;}

  
  /* Save indicator */
  #saveStatus{
    position:fixed; bottom:12px; right:12px; background:var(--accent); color:#fff;
    padding:6px 10px; border-radius:8px; font-size:0.85rem; opacity:0; transition:opacity .25s;
  }

  @media (max-width:900px){ .header-grid{grid-template-columns:1fr} .onetime-charge-options{grid-column: 1 / -1;} }
  @media (max-width:720px){ .policy-grid{grid-template-columns:1fr} .card-digit{width:60px} }
</style>
</head>
<body>
<main>
  <h1>Residency Questionaire (LF5166)</h1>

<section class="section" id="sectionA">
    <h2>Policy Details</h2>

    <div class="row">
    <label>Policy No.
      <input id="ResQ_PolicyNo" type="text" placeholder="Enter Policy No.">
    </label>
    </div>

    <div class="row">
    <label style="flex:1">Proposed Life Insured / Insured
      <input id="ResQ_LifeInsured_Name" type="text" placeholder="Enter Name">
    </label> </div>
</section>
  
     <section class="section">
    <label style="flex:1">1. Please provide details of all citizenship held
      <input id="ResQ_Citizenship" type="text" placeholder="Enter Citizenship">
    </label>
     </section>

  <section class="section">
    <label>2. When did you first start residing in Malaysia?
      <input id="ResQ_StartResiding" type="text" placeholder="Enter Date">
    </label>
  </section>


      <section class="section">
      <label style="flex:1">3. In the past 1 year, how many days did you spend in Malaysia?</label>
      <div class="row">
      <label class="inline"><input name="ResQ_183Daya" id="ResQ_Lessthan183" type="radio">Less than a total of 183 days a year</label>
      <label class="inline"><input name="ResQ_183Daya" id="ResQ_Morethan183" type="radio">More than a total of 183 days a year </label>
    </div>
      </section>

      <section class="section">
      <label style="flex:1">4. In the past 12 months or next 12 months have you traveled or do you plan to travel out of Malaysia?</label>
      <div class="row">
      <label class="inline"><input name="Travel" id="ResQ_Travel_Yes" type="radio">Yes</label>
      <label class="inline"><input name="Travel" id="ResQ_Travel_No" type="radio">No</label>
      </div>
        
      <div id="travelDetails" style="display:none;">
      <div class="row">
        <label class="inline">If yes, please provide travel details. </label>
      </div>
        <div class="row">
          <label><input type="checkbox" id="togglePast">Past 12 Months
    </label>
          <label><input type="checkbox" id="toggleNext">Next 12 Months
    </label>
        </div>
        <div id="nomineesContainer" class="nominee-grid" style="display:none;"></div>
    <div class="row">
      <button id="addNominee">+ Add Another Nominee</button>
      <small class="muted" id="nomineeLimit">Up to 4 Entries</small>
    </div>

         <div id="next12Container" class="next12-grid" style="display:none;"></div>
    <div class="row">
      <button id="addNext12">+ Add Another Entry</button>
      <small class="muted" id="next12Limit">Up to 4 Entries</small>
    </div>
      </div>
      </section>

  <section class="section" id="Occupation">
  <label style="flex:1">5. Please provide details of your occupation during your stay in Malaysia.</label>
  
  <div id="occupationContainer" class="occupation-grid"></div>
    <div class="row"> 
      <button id="addOccupation">+ Add Another Entry</button>
      <small class="muted" id="occupationLimit">Up to 3 Entries</small>
    </div>
  </div>
</section>

  
  <section class="section" id="permanentstayQ">
  <label style="flex:1">6. Do you plan to stay in Malaysia permanently?</label>
  <div class="row">
    <label class="inline">
      <input name="Permanentstay" id="ResQ_Permanent_Yes" type="radio"> Yes
    </label>
    <label class="inline">
      <input name="Permanentstay" id="ResQ_Permanent_No" type="radio"> No
    </label>
  </div>

  <!-- Hidden by default -->
  <div class="row" id="dateleaving" style="display:none;">
    <label>
      If no, when do you plan to leave Malaysia?
      <input id="ResQ_Permanent_No_Date" type="text" placeholder="Enter Date">
    </label>
  </div>
  </section>

<section class="section" id="CompanyOwner">
  <label style="flex:1">7. Are you owner/part-owner or serving on the board of directors of any company out of Malaysia?</label>
  <div class="row">
    <label class="inline"><input name="Compowner-choose" id="ResQ_Company_Yes" type="radio"> Yes </label>
    <label class="inline"><input name="Compowner-choose" id="ResQ_Company_No"  type="radio"> No </label>
  </div>

  <!-- Everything below is hidden unless "Yes" -->
  <div id="compownerDetails" style="display:none;">
    <div class="row" name="providecompdetails">
      <label>If yes, please provide details.</label>
    </div>

    <div id="compownerContainer" class="compowner-grid"></div>

    <div class="row"> 
      <button id="addCompowner">+ Add Another Entry</button>
      <small class="muted" id="compownerLimit">Up to 3 Entries</small>
    </div>
  </div>
</section>

<section class="section">
  <h2>Signature Details</h2>

  <!-- SECTION: Signature Details (Date/Place) -->
    <div class="row">
      <label style="flex:1">Sign Date
          <input id="ResQ_Date" type="text" placeholder="Enter Date">
      </label>
    </div>
</section>
      
  <!-- SECTION: Owner/Policyowner Signature -->
  <section class="section">
  <h3>Life Proposed Signature</h3>

  <!-- Tap-to-sign previews (Owner) -->
  <div class="sig-preview" id="preview_owner" onclick="openSig('owner')">
    <span>Tap to Sign (Policy Owner)</span>
  </div>
  <div class="row">
    <button id="clearPreviewOwner" class="secondary" type="button">Clear Signature</button>
  </div>
  </section>

    <!-- SECTION: Witness Signature -->
  <section class="section">
  <h3>Agent as Witness Signature</h3>

  <!-- Tap-to-sign previews (Witness) -->
  <div class="sig-preview" id="preview_witness" onclick="openSig('witness')">
    <span>Tap to Sign (Witness)</span>
  </div>  
  <div class="row">
    <button id="clearPreviewWitness" class="secondary" type="button">Clear Signature</button>
  </div>
  </section>

  <section class="section actions">
    <button id="generate">Generate PDF</button>
    <button id="resetAll" class="secondary">Reset All</button>
  </section>

</main>

<!-- Signature Modal -->
<div id="sigModal" class="sig-modal" aria-hidden="true">
  <div class="box">
    <h3 id="sigModalTitle">Draw Signature</h3>
    <!-- Responsive canvas: internal pixels are set in JS for crispness -->
    <canvas id="sigCanvas"></canvas>
    <div class="sig-actions">
      <button id="sigDone" type="button">Done</button>
      <button id="sigClear" type="button" class="ghost">Clear</button>
      <button id="sigCancel" type="button" class="secondary">Cancel</button>
    </div>
  </div>
</div>

<div id="saveStatus">Saved</div>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script>
/* ---------- CONFIG ---------- */
const PDF_FILENAME = "ResidencyQuestionnaire_LF5166_012022_fillable.pdf";
const MAX_NOMINEES = 4;
const MAX_NEXT12ENTRY = 4;
const MAX_COMPOWNER = 3;
const MAX_OCCUPATION = 3;

/* ---------- helpers ---------- */
function $(id){return document.getElementById(id);}
function safeSetText(form, name, text){
  try{ form.getTextField(name).setText(String(text || "")); } catch(e){ /* missing field ok */ }
}
function safeCheck(form, name, checked){
  try{ const cb = form.getCheckBox(name); if (checked) cb.check(); else cb.uncheck(); } catch(e){ /* missing field ok */ }
}

/* ----------Universal Save indicator ---------- */
const saveStatusEl = $("saveStatus");
function showSaveStatus(){
  saveStatusEl.style.opacity = 1;
  clearTimeout(saveStatusEl._timer);
  saveStatusEl._timer = setTimeout(()=> saveStatusEl.style.opacity = 0, 1200);
}
function saveElValue(el){
  if(!el || !el.id) return;
  if(el.type === 'checkbox' || el.type === 'radio'){
    localStorage.setItem(el.id, el.checked);
  } else {
    localStorage.setItem(el.id, el.value);
  }
  showSaveStatus();
}
function autoBindSave(el){
  const saved = localStorage.getItem(el.id);
  if(saved !== null){
    if(el.type === 'checkbox' || el.type === 'radio') el.checked = (saved === 'true');
    else el.value = saved;
  }
  el.addEventListener((el.type === 'checkbox' || el.type === 'radio') ? 'change' : 'input', ()=> saveElValue(el));
}

/* ---------- Universal AutoBind Save + Uppercase ---------- */
window.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("input, select, textarea").forEach(el => {
    if (!el.id) return; // skip if no ID

    // Restore + bind saving
    autoBindSave(el);

    // Auto-uppercase rule (exclude Email)
    if (el.type === "text" || el.tagName === "TEXTAREA") {
      if (!el.id.toLowerCase().includes("email")) {
        el.addEventListener("input", () => {
          const cursor = el.selectionStart;
          el.value = el.value.toUpperCase();
          el.setSelectionRange(cursor, cursor); // keep caret
          saveElValue(el); // ensure saved after transform
        });
      }
    }
  });
});


/* ---------- SECTION B: Dynamic Nominees Container ---------- */
const nomineesContainer = $("nomineesContainer");
const addNomineeBtn = $("addNominee");
let nomineeCount = parseInt(localStorage.getItem("nomineeCount")) || 0;

  
// Create Nominee Entry
function createNomineeEntry(index){
  const wrap = document.createElement("div");
  wrap.className = "nominee";
  wrap.dataset.index = index;
  wrap.innerHTML = `
    <h3><span>PAST 12 Months Travel Details (Entry ${index})</span>
    <button type="button" class="remove-btn" aria-label="Remove nominee">Remove</button></h3>
    <label>Country
     <input type="text" id="ResQ_TravelP12_Country${index}"></label>
    <label>Cities
      <input type="text" id="ResQ_TravelP12_City${index}">
    </label>
    <label>Duration Per Visit
      <input type="text" id="ResQ_TravelP12_Duration${index}">
    </label>
    <label>Frequency Per Year
      <input type="text" id="ResQ_TravelP12_Frequency${index}">
    </label>
    <label>Date
      <input type="text" id="ResQ_TravelP12_Date${index}">
    </label>
    <label>Purpose
      <input type="text" id="ResQ_Travel_Purpose${index}">
    </label>
`;

  // Auto uppercase for all text inputs (Nominee Container)
  wrap.querySelectorAll("input[type=text]").forEach(el=>{
  if(el.id.includes("_Email")) return; // ❌ skip auto-uppercase for Email
  el.addEventListener("input", ()=>{ 
    el.value = el.value.toUpperCase(); 
    saveElValue(el); 
  });
});

  // Bind all inputs/selects to save (Nominess Container)
  wrap.querySelectorAll("input, select").forEach(el=>{
    autoBindSave(el);
    const saved = localStorage.getItem(el.id);
    if(saved!==null){
      if(el.type==="checkbox") el.checked = saved==="true";
      else el.value = saved;
    }
  });



  // Remove button (Nominee Container)
  wrap.querySelector(".remove-btn").addEventListener("click", ()=>{
    nomineesContainer.removeChild(wrap);
    nomineeCount = Math.max(0, nomineeCount - 1);
    addNomineeBtn.disabled = nomineeCount >= MAX_NOMINEES;
    renumberNominees();
    showSaveStatus();
  });

  return wrap;
}

// ADD Nominee Entry (Nominee Container)
function addNominee(){
  if(nomineeCount >= MAX_NOMINEES) return;
  nomineeCount++;
  const node = createNomineeEntry(nomineeCount);
  nomineesContainer.appendChild(node);
  addNomineeBtn.disabled = nomineeCount >= MAX_NOMINEES;
  localStorage.setItem("nomineeCount", nomineeCount);
  showSaveStatus();
}


// RENUMBER (Nominee Container)
function renumberNominees(){
  const cards = Array.from(nomineesContainer.querySelectorAll(".nominee"));
  nomineeCount = cards.length;
  localStorage.setItem("nomineeCount", nomineeCount);
}

// INIT (Nominee Container)
addNomineeBtn.addEventListener("click", addNominee);


// Restore saved nominees (Nominee Container)
// ---------- Nominee Initialization ----------
if (nomineeCount === 0) {
  // Always start with Nominee 1
  nomineeCount = 1;
  localStorage.setItem("nomineeCount", nomineeCount);
  nomineesContainer.appendChild(createNomineeEntry(1));
} else {
  // Restore all saved nominees 1..nomineeCount
  for (let i = 1; i <= nomineeCount; i++) {
    nomineesContainer.appendChild(createNomineeEntry(i));
  }
}

addNomineeBtn.disabled = nomineeCount >= MAX_NOMINEES;

/* ---------- SECTION next 12 months Container ---------- */
const next12Container = $("next12Container");
const addNext12Btn = $("addNext12");
let next12Count = parseInt(localStorage.getItem("next12Count")) || 0;

   
// Create Next12 Entry
function createNext12Entry(index){
  const wrap = document.createElement("div");
  wrap.className = "next12";
  wrap.dataset.index = index;
  wrap.innerHTML = `
    <h3><span>NEXT 12 Months Travel Details (Entry ${index})</span>
    <button type="button" class="remove-btn" aria-label="Remove Entry">Remove</button></h3>
    <label>Country
     <input type="text" id="ResQ_Travel_N12_Country${index}"></label>
    <label>Cities
      <input type="text" id="ResQ_Travel_N12_City${index}">
    </label>
    <label>Duration Per Visit
      <input type="text" id="ResQ_Travel_N12_Duration${index}">
    </label>
    <label>Frequency Per Year
      <input type="text" id="ResQ_Travel_N12_Frequency${index}">
    </label>
    <label>Date
      <input type="text" id="ResQ_Travel_N12_Date${index}">
    </label>
    <label>Purpose
      <input type="text" id="ResQ_Travel_N12_Purpose${index}">
    </label>

     `;

  // Auto uppercase for all text inputs (Nominee Container)
  wrap.querySelectorAll("input[type=text]").forEach(el=>{
  if(el.id.includes("_Email")) return; // ❌ skip auto-uppercase for Email
  el.addEventListener("input", ()=>{ 
    el.value = el.value.toUpperCase(); 
    saveElValue(el); 
  });
});

  // Bind all inputs/selects to save (Next12 Container)
  wrap.querySelectorAll("input, select").forEach(el=>{
    autoBindSave(el);
    const saved = localStorage.getItem(el.id);
    if(saved!==null){
      if(el.type==="checkbox") el.checked = saved==="true";
      else el.value = saved;
    }
  });



  // Remove button (Next12 Container)
  wrap.querySelector(".remove-btn").addEventListener("click", ()=>{
    next12Container.removeChild(wrap);
    next12Count = Math.max(0, next12Count - 1);
    addNext12Btn.disabled = next12Count >= MAX_NEXT12ENTRY;
    renumberNext12();
    showSaveStatus();
  });

  return wrap;
}

// ADD Next12 Entry (Next12 Container)
function addNext12(){
  if(next12Count >= MAX_NEXT12ENTRY) return;
  next12Count++;
  const node = createNext12Entry(next12Count);
  next12Container.appendChild(node);
  addNext12Btn.disabled = next12Count >= MAX_NEXT12ENTRY;
  localStorage.setItem("next12Count", next12Count);
  showSaveStatus();
}

// RENUMBER (Next12 Container)
function renumberNext12(){
  const cards = Array.from(next12Container.querySelectorAll(".next12"));
  next12Count = cards.length;
  localStorage.setItem("next12Count", next12Count);
}

// INIT (Next12 Container)
addNext12Btn.addEventListener("click", addNext12);


// Restore saved nominees (Next12 Container)
// ---------- Next12 Initialization ----------
if (next12Count === 0) {
  // Always start with Next12 1
  next12Count = 1;
  localStorage.setItem("next12Count", next12Count);
  next12Container.appendChild(createNext12Entry(1));
} else {
  // Restore all saved next12 1..next12Count
  for (let i = 1; i <= next12Count; i++) {
    next12Container.appendChild(createNext12Entry(i));
  }
}

addNext12Btn.disabled = next12Count >= MAX_NEXT12ENTRY;


/* ---------- toggle switch for Past12 and Next12 Container ---------- */
/* ---------- toggle switch for Travel Yes/No ---------- */
const travelYes = document.getElementById("ResQ_Travel_Yes");
const travelNo = document.getElementById("ResQ_Travel_No");
const travelDetails = document.getElementById("travelDetails");

/* ---------- toggle switch for Past12 and Next12 Container ---------- */
const togglePast = document.getElementById("togglePast");
const toggleNext = document.getElementById("toggleNext");
const nomineeLimit = document.getElementById("nomineeLimit");
const next12Limit = document.getElementById("next12Limit");


// Show/hide travelDetails section based on Yes/No
function updateTravelDetails() {
  if (travelYes.checked) {
    travelDetails.style.display = "block";
  } else {
    travelDetails.style.display = "none";
    // reset past/next when No
    togglePast.checked = false;
    toggleNext.checked = false;
    updateToggleUI();
  }

  // Save Yes/No to localStorage
  localStorage.setItem("travelAnswer", travelYes.checked ? "yes" : "no");
}

// Show/hide Past & Next sections separately
function updateToggleUI() {
  if (togglePast.checked) {
    nomineesContainer.style.display = "block";
    addNomineeBtn.style.display = "inline-block";
    nomineeLimit.style.display = "block";

    // Ensure at least 1 nominee exists when shown
    if (nomineeCount === 0) {
      addNominee();
    }
  } else {
    nomineesContainer.style.display = "none";
    addNomineeBtn.style.display = "none";
    nomineeLimit.style.display = "none";
  }

  if (toggleNext.checked) {
    next12Container.style.display = "block";
    addNext12Btn.style.display = "inline-block";
    next12Limit.style.display = "block";

    // Ensure at least 1 entry exists when shown
    if (next12Count === 0) {
      addNext12();
    }
  } else {
    next12Container.style.display = "none";
    addNext12Btn.style.display = "none";
    next12Limit.style.display = "none";
  }


  // Save Past/Next to localStorage
  localStorage.setItem("travelPeriod", JSON.stringify({
    past: togglePast.checked,
    next: toggleNext.checked
  }));
}

/* ---------- Bind events ---------- */
travelYes.addEventListener("change", updateTravelDetails);
travelNo.addEventListener("change", updateTravelDetails);
togglePast.addEventListener("change", updateToggleUI);
toggleNext.addEventListener("change", updateToggleUI);

/* ---------- On page load, restore saved state ---------- */
document.addEventListener("DOMContentLoaded", () => {
  // Restore Yes/No
  const savedAnswer = localStorage.getItem("travelAnswer");
  if (savedAnswer === "yes") {
    travelYes.checked = true;
  } else if (savedAnswer === "no") {
    travelNo.checked = true;
  }

  // Restore Past/Next
  const savedPeriod = JSON.parse(localStorage.getItem("travelPeriod") || "{}");
  togglePast.checked = savedPeriod.past || false;
  toggleNext.checked = savedPeriod.next || false;

  // Update UI
  updateTravelDetails();
  updateToggleUI();
});

  /* ---------- SECTION Company Owner Container ---------- */
const compownerContainer = $("compownerContainer");
const addCompownerBtn    = $("addCompowner");
const compownerLimit     = $("compownerLimit");
const compownerYes       = $("ResQ_Company_Yes");
const compownerNo        = $("ResQ_Company_No");
const compownerDetails   = $("compownerDetails");
let compownerCount = parseInt(localStorage.getItem("compownerCount")) || 0;

   
// Create Compowner Entry
function createCompownerEntry(index){
  const wrap = document.createElement("div");
  wrap.className = "compowner";
  wrap.dataset.index = index;
  wrap.innerHTML = `
    <h3><span>Company Details (Entry ${index})</span>
    <button type="button" class="remove-btn" aria-label="Remove Entry">Remove</button></h3>
    <label>Name of Company
     <input type="text" id="ResQ_Company_Name${index}"></label>
    <label>Years Incorporated
      <input type="text" id="ResQ_Company_Year${index}">
    </label>
    <label>Country Incorporated
      <input type="text" id="ResQ_Company_Country${index}">
    </label>
    <label>Percentage of Ownership
      <input type="text" id="ResQ_Company_Percent${index}">
    </label>
    <label>Nature of Business
      <input type="text" id="ResQ_Company_Nature${index}">
    </label>

     `;

  // Auto uppercase for all text inputs (Compowner Container)
  wrap.querySelectorAll("input[type=text]").forEach(el=>{
  if(el.id.includes("_Email")) return; // ❌ skip auto-uppercase for Email
  el.addEventListener("input", ()=>{ 
    el.value = el.value.toUpperCase(); 
    saveElValue(el); 
  });
});

  // Bind all inputs/selects to save (Compowner Container)
  wrap.querySelectorAll("input, select").forEach(el=>{
    autoBindSave(el);
    const saved = localStorage.getItem(el.id);
    if(saved!==null){
      if(el.type==="checkbox") el.checked = saved==="true";
      else el.value = saved;
    }
  });



  // Remove button (Compowner Container)
  wrap.querySelector(".remove-btn").addEventListener("click", ()=>{
    compownerContainer.removeChild(wrap);
    compownerCount = Math.max(0, compownerCount - 1);
    addCompownerBtn.disabled = compownerCount >= MAX_COMPOWNER;
    renumberCompowner();
    showSaveStatus();
  });

  return wrap;
}

// ADD Compowner Entry (Compowner Container)
function addCompowner(){
  if(compownerCount >= MAX_COMPOWNER) return;
  compownerCount++;
  const node = createCompownerEntry(compownerCount);
  compownerContainer.appendChild(node);
  addCompownerBtn.disabled = compownerCount >= MAX_COMPOWNER;
  localStorage.setItem("compownerCount", compownerCount);
  showSaveStatus();
}

// RENUMBER (Compowner Container)
function renumberCompowner(){
  const cards = Array.from(compownerContainer.querySelectorAll(".compowner"));
  compownerCount = cards.length;
  localStorage.setItem("compownerCount", compownerCount);
}

// INIT (Comppwner Container)
addCompownerBtn.addEventListener("click", addCompowner);


// Restore saved nominees (Comppwner Container)

function restoreCompownerEntries(){
  compownerContainer.innerHTML = "";
  // “Same as next12”: ensure at least 1 card exists
  if (compownerCount === 0) {
    compownerCount = 1;
    localStorage.setItem("compownerCount", 1);
  }
  for (let i = 1; i <= compownerCount; i++){
    compownerContainer.appendChild(createCompownerEntry(i));
  }
  addCompownerBtn.disabled = compownerCount >= MAX_COMPOWNER;
}

/* ---------- Toggle for Company Owner Section ---------- */function updateCompownerDisplay(){
  const yes = compownerYes.checked;
  compownerDetails.style.display = yes ? "block" : "none";

  // If user just turned it on and no entries exist, create/restore them
  if (yes && compownerContainer.children.length === 0){
    restoreCompownerEntries();
  }
  localStorage.setItem("compownerAnswer", yes ? "yes" : "no");
}

compownerYes.addEventListener("change", updateCompownerDisplay);
compownerNo .addEventListener("change", updateCompownerDisplay);

document.addEventListener("DOMContentLoaded", () => {
  const savedAnswer = localStorage.getItem("compownerAnswer");
  if (savedAnswer === "yes") compownerYes.checked = true;
  else if (savedAnswer === "no") compownerNo.checked = true;

  restoreCompownerEntries();
  updateCompownerDisplay();
});


/* ---------- SECTION Occupation Container ---------- */
const occupationContainer = $("occupationContainer");
const addOccupationBtn = $("addOccupation");
let occupationCount = parseInt(localStorage.getItem("occupationCount")) || 0;

   
// Create Occupation Entry
function createOccupationEntry(index){
  const wrap = document.createElement("div");
  wrap.className = "occupation";
  wrap.dataset.index = index;
  wrap.innerHTML = `
    <h3><span>Occupation Details (Entry ${index})</span>
    <button type="button" class="remove-btn" aria-label="Remove Entry">Remove</button></h3>
    <label>Date
     <input type="text" id="ResQ_Occupation_Date${index}"></label>
    <label>Occupation
      <input type="text" id="ResQ_Occupation_${index}">
    </label>
    <label>Duration
      <input type="text" id="ResQ_Occupation_Duration${index}">
    </label>

     `;

  // Auto uppercase for all text inputs (Occupation Container)
  wrap.querySelectorAll("input[type=text]").forEach(el=>{
  if(el.id.includes("_Email")) return; // ❌ skip auto-uppercase for Email
  el.addEventListener("input", ()=>{ 
    el.value = el.value.toUpperCase(); 
    saveElValue(el); 
  });
});

  // Bind all inputs/selects to save (Occupation Container)
  wrap.querySelectorAll("input, select").forEach(el=>{
    autoBindSave(el);
    const saved = localStorage.getItem(el.id);
    if(saved!==null){
      if(el.type==="checkbox") el.checked = saved==="true";
      else el.value = saved;
    }
  });



  // Remove button (Occupation Container)
  wrap.querySelector(".remove-btn").addEventListener("click", ()=>{
    occupationContainer.removeChild(wrap);
    occupationCount = Math.max(0, occupationCount - 1);
    addOccupationBtn.disabled = occupationCount >= MAX_OCCUPATION;
    renumberOccupation();
    showSaveStatus();
  });

  return wrap;
}

// ADD Occupation Entry (Occupation Container)
function addOccupation(){
  if(occupationCount >= MAX_OCCUPATION) return;
  occupationCount++;
  const node = createOccupationEntry(occupationCount);
  occupationContainer.appendChild(node);
  addOccupationBtn.disabled = occupationCount >= MAX_OCCUPATION;
  localStorage.setItem("occupationCount", occupationCount);
  showSaveStatus();
}

// RENUMBER (Occupation Container)
function renumberOccupation(){
  const cards = Array.from(occupationContainer.querySelectorAll(".occupation"));
  occupationCount = cards.length;
  localStorage.setItem("occupationCount", occupationCount);
}

// INIT (Occupation Container)
addOccupationBtn.addEventListener("click", addOccupation);


// Restore saved nominees (Occupation Container)
// ---------- Occupation Initialization ----------
if (occupationCount > 0) {
  // Restore all saved occupation 1..occupationCount
  for (let i = 1; i <= occupationCount; i++) {
    occupationContainer.appendChild(createOccupationEntry(i));
  }
} else {
  // No saved entries → start with just 1
  occupationCount = 1;
  localStorage.setItem("occupationCount", occupationCount);
  occupationContainer.appendChild(createOccupationEntry(1));
}

addNext12Btn.disabled = occupationCount >= MAX_OCCUPATION;

/* ---------- SECTION Permanent Stay Logic ---------- */
document.addEventListener("DOMContentLoaded", function () {
  const yesRadio = document.getElementById("ResQ_Permanent_Yes");
  const noRadio = document.getElementById("ResQ_Permanent_No");
  const dateRow = document.getElementById("dateleaving");
  const dateInput = document.getElementById("ResQ_Permanent_No_Date");

  function togglePermanentStay() {
    if (noRadio.checked) {
      dateRow.style.display = "block";
    } else {
      dateRow.style.display = "none";
      dateInput.value = ""; // clear when hidden
    }
  }

  yesRadio.addEventListener("change", togglePermanentStay);
  noRadio.addEventListener("change", togglePermanentStay);

  // Run once at load to restore state if prefilled
  togglePermanentStay();
});

/* ---------- SIGNATURE MODAL LOGIC (Owner + Payor) with HiDPI scaling ---------- */
let sigTarget = null;
const sigModal = $("sigModal");
const sigCanvas = $("sigCanvas");
const sigCtx = sigCanvas.getContext("2d");
let drawing = false;
let scaleX = 1, scaleY = 1;

/* Resize canvas to look crisp on any screen size & DPR */
function resizeSigCanvas(){
  const dpr = window.devicePixelRatio || 1;
  const cssWidth = sigCanvas.clientWidth || sigCanvas.parentElement.clientWidth || 560;
  const cssHeight = sigCanvas.clientHeight || 220;
  sigCanvas.width = Math.max(1, Math.floor(cssWidth * dpr));
  sigCanvas.height = Math.max(1, Math.floor(cssHeight * dpr));
  sigCtx.setTransform(1,0,0,1,0,0); // reset
  sigCtx.scale(dpr, dpr);
  sigCtx.lineWidth = 2;
  sigCtx.lineCap = "round";
  sigCtx.strokeStyle = "#000";
  scaleX = sigCanvas.width / (sigCanvas.getBoundingClientRect().width || cssWidth);
  scaleY = sigCanvas.height / (sigCanvas.getBoundingClientRect().height || cssHeight);
  // White background (prevents transparent PNG on PDFs)
  //sigCtx.fillStyle = "#fff";
  //sigCtx.fillRect(0,0,sigCanvas.width/scaleX, sigCanvas.height/scaleY);
}

function openSig(target){
  sigTarget = target; // 'owner' | 'witness'

if (target === 'owner') {
  $("sigModalTitle").textContent = "Sign: Policy Owner";
} else if (target === 'witness') {
  $("sigModalTitle").textContent = "Sign: Witness";
}

  sigModal.style.display = "block";
  sigModal.setAttribute("aria-hidden", "false");

  // Next frame: ensure layout settled then resize canvas
  requestAnimationFrame(()=>{
    resizeSigCanvas();
    // If there is an existing signature, draw it to current canvas size
    const existing = localStorage.getItem("sig_"+target);
    if (existing){
      const img = new Image();
      img.onload = ()=>{
        // cover the canvas area with existing image
        sigCtx.drawImage(img, 0, 0, sigCanvas.width/scaleX, sigCanvas.height/scaleY);
      };
      img.src = existing;
    }
  });
}
$("sigClear").addEventListener("click", ()=>{
  sigCtx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
  // Repaint white bg in CSS pixels
  //sigCtx.fillStyle="#fff"; sigCtx.fillRect(0,0,sigCanvas.width/scaleX, sigCanvas.height/scaleY);
});
$("sigCancel").addEventListener("click", closeSigModal);
function closeSigModal(){
  sigModal.style.display = "none";
  sigModal.setAttribute("aria-hidden", "true");
  sigTarget = null;
}
$("sigDone").addEventListener("click", ()=>{
  if(!sigTarget) return;
  const dataURL = sigCanvas.toDataURL("image/png");
  localStorage.setItem("sig_resq_"+sigTarget, dataURL);
  const preview = $("preview_"+sigTarget);
  preview.innerHTML = `<img alt="Signature ${sigTarget}" src="${dataURL}">`;
  closeSigModal();
});

/* Drawing (mouse + touch) with coordinate conversion */
function getPos(e){
  const rect = sigCanvas.getBoundingClientRect();
  if(e.touches && e.touches[0]){
    return { x: (e.touches[0].clientX - rect.left), y: (e.touches[0].clientY - rect.top) };
  }
  return { x: (e.clientX - rect.left), y: (e.clientY - rect.top) };
}
function startDraw(e){
  drawing = true;
  sigCtx.beginPath();
  const {x,y}=getPos(e);
  sigCtx.moveTo(x, y);
  e.preventDefault?.();
}
function endDraw(){ drawing = false; sigCtx.beginPath(); }
function moveDraw(e){
  if(!drawing) return;
  const {x,y} = getPos(e);
  sigCtx.lineTo(x, y);
  sigCtx.stroke();
  sigCtx.beginPath();
  sigCtx.moveTo(x, y);
  e.preventDefault?.();
}
sigCanvas.addEventListener("mousedown", startDraw);
sigCanvas.addEventListener("mousemove", moveDraw);
window.addEventListener("mouseup", endDraw);
sigCanvas.addEventListener("touchstart", startDraw, {passive:false});
sigCanvas.addEventListener("touchmove", moveDraw, {passive:false});
sigCanvas.addEventListener("touchend", endDraw);
window.addEventListener("resize", ()=> {
  // Only resize when modal is open to avoid reflow glitches
  if(sigModal.getAttribute("aria-hidden")==="false"){ 
    const img = new Image();
    img.onload = ()=>{
      resizeSigCanvas();
      sigCtx.drawImage(img, 0, 0, sigCanvas.width/scaleX, sigCanvas.height/scaleY);
    };
    img.src = sigCanvas.toDataURL("image/png");
  }
});

/* Clear preview buttons + restore previews on load */
$("clearPreviewOwner").addEventListener("click", ()=>{
  localStorage.removeItem("sig_resq_owner");
  $("preview_owner").innerHTML = `<span>Tap to Sign (Owner)</span>`;
});
$("clearPreviewWitness").addEventListener("click", ()=>{
  localStorage.removeItem("sig_resq_witness");
  $("preview_witness").innerHTML = `<span>Tap to Sign (Witness)</span>`;
});

window.addEventListener("DOMContentLoaded", ()=>{
  ["owner","witness"].forEach(role=>{
    const saved = localStorage.getItem("sig_"+role);
    if(saved){ $("preview_"+role).innerHTML = `<img alt="Signature ${role}" src="${saved}">`; }
  });
});

/* ---------- Generate PDF ---------- */
async function fillPDF(){
  try {
    $("generate").disabled = true;

    const res = await fetch(PDF_FILENAME);
    if (!res.ok) throw new Error("Cannot load PDF: " + PDF_FILENAME);
    const bytes = await res.arrayBuffer();
    const pdfDoc = await PDFLib.PDFDocument.load(bytes);
    const form = pdfDoc.getForm();

  // All Text and Radio button FillPDF
  //Text input
  safeSetText(form, "ResQ_PolicyNo", $("ResQ_PolicyNo").value);
  safeSetText(form, "ResQ_LifeInsured_Name", $("ResQ_LifeInsured_Name").value);
  safeSetText(form, "ResQ_Citizenship", $("ResQ_Citizenship").value);
  safeSetText(form, "ResQ_StartResiding", $("ResQ_StartResiding").value);
  safeSetText(form, "ResQ_Permanent_No_Date", $("ResQ_Permanent_No_Date").value);
  safeSetText(form, "ResQ_Date", $("ResQ_Date").value);

  //Radio Input
  safeCheck(form, "ResQ_Morethan183", $("ResQ_Morethan183").checked);
  safeCheck(form, "ResQ_Lessthan183", $("ResQ_Lessthan183").checked);
  safeCheck(form, "ResQ_Travel_Yes", $("ResQ_Travel_Yes").checked);
  safeCheck(form, "ResQ_Travel_No", $("ResQ_Travel_No").checked);
  safeCheck(form, "ResQ_Permanent_Yes", $("ResQ_Permanent_Yes").checked);
  safeCheck(form, "ResQ_Permanent_No", $("ResQ_Permanent_No").checked);
  safeCheck(form, "ResQ_Company_Yes", $("ResQ_Company_Yes").checked);
  safeCheck(form, "ResQ_Company_No", $("ResQ_Company_No").checked);
    
    // Past12 Container FillPDF
  const nomineesContainer = document.getElementById("nomineesContainer");
  const nominees = nomineesContainer.querySelectorAll(".nominee");

  nominees.forEach(n => {
  const idx = n.dataset.index; // example: "1", "2"
  
  // Past12 Container - Now read all fields and push to PDF
  safeSetText(form, `ResQ_TravelP12_Country${idx}`, n.querySelector(`#ResQ_TravelP12_Country${idx}`)?.value);
  safeSetText(form, `ResQ_TravelP12_City${idx}`, n.querySelector(`#ResQ_TravelP12_City${idx}`)?.value);
  safeSetText(form, `ResQ_TravelP12_Duration${idx}`, n.querySelector(`#ResQ_TravelP12_Duration${idx}`)?.value);
  safeSetText(form, `ResQ_TravelP12_Frequency${idx}`, n.querySelector(`#ResQ_TravelP12_Frequency${idx}`)?.value);
  safeSetText(form, `ResQ_TravelP12_Date${idx}`, n.querySelector(`#ResQ_TravelP12_Date${idx}`)?.value);
  safeSetText(form, `ResQ_Travel_Purpose${idx}`, n.querySelector(`#ResQ_Travel_Purpose${idx}`)?.value);
  });


      // Next12 Container FillPDF
  const next12Container = document.getElementById("next12Container");
  const next12 = next12Container.querySelectorAll(".next12");

  next12.forEach(n => {
  const idx = n.dataset.index; // example: "1", "2"
  
  // Next12 Container - Now read all fields and push to PDF
  safeSetText(form, `ResQ_Travel_N12_Country${idx}`, n.querySelector(`#ResQ_Travel_N12_Country${idx}`)?.value);
  safeSetText(form, `ResQ_Travel_N12_City${idx}`, n.querySelector(`#ResQ_Travel_N12_City${idx}`)?.value);
  safeSetText(form, `ResQ_Travel_N12_Duration${idx}`, n.querySelector(`#ResQ_Travel_N12_Duration${idx}`)?.value);
  safeSetText(form, `ResQ_Travel_N12_Frequency${idx}`, n.querySelector(`#ResQ_Travel_N12_Frequency${idx}`)?.value);
  safeSetText(form, `ResQ_Travel_N12_Date${idx}`, n.querySelector(`#ResQ_Travel_N12_Date${idx}`)?.value);
  safeSetText(form, `ResQ_Travel_N12_Purpose${idx}`, n.querySelector(`#ResQ_Travel_N12_Purpose${idx}`)?.value);
  });

    // Occupation Container FillPDF
  const occupationContainer = document.getElementById("occupationContainer");
  const occupation = occupationContainer.querySelectorAll(".occupation");

  occupation.forEach(n => {
  const idx = n.dataset.index; // example: "1", "2"
  
  // Occupation Container - Now read all fields and push to PDF
  safeSetText(form, `ResQ_Occupation_Date${idx}`, n.querySelector(`#ResQ_Occupation_Date${idx}`)?.value);
  safeSetText(form, `ResQ_Occupation_${idx}`, n.querySelector(`#ResQ_Occupation_${idx}`)?.value);
  safeSetText(form, `ResQ_Occupation_Duration${idx}`, n.querySelector(`#ResQ_Occupation_Duration${idx}`)?.value);
  });

      // Company owner Container FillPDF
  const compownerContainer = document.getElementById("compownerContainer");
  const compowner = compownerContainer.querySelectorAll(".compowner");

  compowner.forEach(n => {
  const idx = n.dataset.index; // example: "1", "2"
  
  // Occupation Container - Now read all fields and push to PDF
  safeSetText(form, `ResQ_Company_Name${idx}`, n.querySelector(`#ResQ_Company_Name${idx}`)?.value);
  safeSetText(form, `ResQ_Company_Year_${idx}`, n.querySelector(`#ResQ_Company_Year${idx}`)?.value);
  safeSetText(form, `ResQ_Company_Country${idx}`, n.querySelector(`#ResQ_Company_Country${idx}`)?.value);
  safeSetText(form, `ResQ_Company_Percent${idx}`, n.querySelector(`#ResQ_Company_Percent${idx}`)?.value);
  safeSetText(form, `ResQ_Company_Nature${idx}`, n.querySelector(`#ResQ_Company_Nature${idx}`)?.value);
  });

    /* --------- SIGNATURE IMAGE EMBEDDING (embedPng + drawImage) --------- */
    const pages = pdfDoc.getPages();
    const pageIndex = 1; // Printed on page 2
    const page = pages[pageIndex];

// Owner signature FillPDF
const sigOwner = localStorage.getItem("sig_resq_owner");
if (sigOwner) {
  try {
    const imgOwner = await pdfDoc.embedPng(sig_resq_owner);
    const { width, height } = imgOwner.size();

    const previewEl = document.getElementById("preview_owner");
    const boxW = previewEl.offsetWidth;
    const boxH = previewEl.offsetHeight;

    const scale = Math.min(boxW / width, boxH / height);
    let drawW = width * scale;
    let drawH = height * scale;

    const factor = 0.40;    // 40% scale
    const posX = 50;         // X position on PDF
    const posY = 240;        // Y position on PDF

    drawW *= factor;
    drawH *= factor;

    page.drawImage(imgOwner, {
      x: posX,
      y: posY,
      width: drawW,
      height: drawH
    });
  } catch (e) {
    console.error(e);
  }
}

// Witness signature FillPDF
const sigWitness = localStorage.getItem("sig_resq_witness");
if (sigWitness) {
  try {
    const imgWitness = await pdfDoc.embedPng(sig_resq_witness);
    const { width, height } = imgWitness.size();

    const previewEl = document.getElementById("preview_witness");
    const boxW = previewEl.offsetWidth;
    const boxH = previewEl.offsetHeight;

    const scale = Math.min(boxW / width, boxH / height);
    let drawW = width * scale;
    let drawH = height * scale;

    const factor = 0.40;    // 45% scale
    const posX = 420;         // X position on PDF
    const posY = 240;        // Y position on PDF

    drawW *= factor;
    drawH *= factor;

    page.drawImage(imgWitness, {
      x: posX,
      y: posY,
      width: drawW,
      height: drawH
    });
  } catch (e) {
    console.error(e);
  }
}


    // Flatten form fields before saving
    form.flatten();
    
    // Save & download FillPDF
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "Filled_Residency_Questionaire.pdf"; 
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 2500);

  } catch(err){
    alert("PDF generation failed: " + (err.message || err));
    console.error(err);
  } finally {
    $("generate").disabled = false;
  }
}


/* ---------- RESET ALL DATA function ---------- */
function resetAll() {
  if (!confirm("Are you sure you want to reset the form? All saved data will be cleared.")) {
    return;
  }

  // 1) Clear ALL saved keys that belong to this form
  //    (Everything starting with "Nom_" plus legacy signature keys)
  const keys = Object.keys(localStorage);
  keys.forEach(k => {
    if (k.startsWith("ResQ_")) localStorage.removeItem(k);
  });
  // Legacy sig keys (if you still use these)
  ["sig_resq_owner","sig_resq_witness"].forEach(k => localStorage.removeItem(k));

  // 2) Clear the live UI values for Section A/E (inputs that remain in DOM)
  document.querySelectorAll("input, select, textarea").forEach(el => {
    if (!el.id) return;
    if (el.type === "checkbox" || el.type === "radio") el.checked = false;
    else el.value = "";
  });

  // 3) Rebuild Nominees UI to exactly ONE card (Nominee 1)
  nomineesContainer.innerHTML = "";
  nomineeCount = 1;
  localStorage.setItem("nomineeCount", 1);
  nomineesContainer.appendChild(createNomineeEntry(1));
  addNomineeBtn.disabled = false;

  // 4) Reset signature previews
  $("preview_owner").innerHTML   = `<span>Tap to Sign (Policy Owner)</span>`;
  $("preview_witness").innerHTML = `<span>Tap to Sign (Witness)</span>`;

  showSaveStatus();
}


/* ---------- Wire buttons ---------- */
$("generate").addEventListener("click", fillPDF);
$("resetAll").addEventListener("click", resetAll);
</script>
</body>
</html>
